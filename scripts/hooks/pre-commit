#!/bin/sh

# Get the current user and timestamp
current_user=$(git config user.name)
current_timestamp=$(date +"%Y-%m-%d %H:%M:%S")

# Function to add or update metadata in a file
update_metadata() {
    file=$1
    if grep -q "Created by:" "$file"; then
        # Update last modified details
        sed -i.bak -E "s/(# Last Modified by: ).*/\1$current_user/" "$file"
        sed -i.bak -E "s/(# Last Modified date: ).*/\1$current_timestamp/" "$file"
        # Increment version number
        current_version=$(grep -E "# Version: " "$file" | sed -E "s/# Version: ([0-9]+\.[0-9]+)/\1/")
        major_version=$(echo $current_version | cut -d. -f1)
        minor_version=$(echo $current_version | cut -d. -f2)
        if [ $minor_version -eq 9 ]; then
            new_major_version=$((major_version + 1))
            new_minor_version=0
        else
            new_major_version=$major_version
            new_minor_version=$((minor_version + 1))
        fi
        new_version="$new_major_version.$new_minor_version"
        sed -i.bak -E "s/(# Version: ).*/\1$new_version/" "$file"
    else
        # Add creator details and initial version
        echo "# Created by: $current_user" > "$file.tmp"
        echo "# Created date: $current_timestamp" >> "$file.tmp"
        echo "# Version: 1.0" >> "$file.tmp"
        echo "# Last Modified by: $current_user" >> "$file.tmp"
        echo "# Last Modified date: $current_timestamp" >> "$file.tmp"
        echo " " >> "$file.tmp"
        cat "$file" >> "$file.tmp"
        mv "$file.tmp" "$file"
    fi
    rm -f "$file.bak"
}

# Find all SQLX and PY files that are staged for commit
for file in $(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(sqlx|sql|py)$'); do
    update_metadata "$file"
    git add "$file"
done

exit 0
